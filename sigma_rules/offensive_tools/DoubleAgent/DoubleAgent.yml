title: Simple keyword detection rule for DoubleAgent
id: 12f5b00a-acf1-4e55-8690-de46b36938f2
status: experimental
description:
- '''DoubleAgent gives the attacker the ability to inject any DLL into any process.
  The code injection occurs extremely early during the victims process boot. giving
  the attacker full control over the process and no way for the process to protect
  itself. The code injection technique is so unique that its not detected or blocked
  by any antivirus.DoubleAgent can continue injecting code even after reboot making
  it a perfect persistence technique to survive reboots/updates/reinstalls/patches/etc.
  Once the attacker decides to inject a DLL into a process. they are forcefully bounded
  forever. Even if the victim would completely uninstall and reinstall its program.
  the attackers DLL would still be injected every time the process executes.'''
references:
- https://github.com/Cybellum/DoubleAgent
author: '@mthcht'
date: 2023/07/30
modified: 2023/08/06
tags:
- attack.T1053
- attack.T1055
- attack.T1059
- attack.TA0002
- attack.TA0003
- attack.TA0008
logsource:
  category:
  - endpoint
  - network
falsepositives:
- Unknown
level:
- Unknown
detection:
  selection:
    Image:
    - '*DoubleAgent.sln*'
    OriginalFileName:
    - '*DoubleAgent.sln*'
    CurrentDirectory:
    - '*DoubleAgent.sln*'
    ParentImage:
    - '*DoubleAgent.sln*'
    ParentCommandLine:
    - '*DoubleAgent.sln*'
    TargetFilename:
    - '*DoubleAgent.sln*'
    Signature:
    - '*DoubleAgent.sln*'
    signature:
    - '*DoubleAgent.sln*'
    ImageLoaded:
    - '*DoubleAgent.sln*'
    Company:
    - '*DoubleAgent.sln*'
    Description:
    - '*DoubleAgent.sln*'
    description:
    - '*DoubleAgent.sln*'
    CommandLine:
    - '*DoubleAgent.sln*'
    SourceImage:
    - '*DoubleAgent.sln*'
    TargetImage:
    - '*DoubleAgent.sln*'
    CallTrace:
    - '*DoubleAgent.sln*'
    TargetObject:
    - '*DoubleAgent.sln*'
    Details:
    - '*DoubleAgent.sln*'
    PipeName:
    - '*DoubleAgent.sln*'
    Consumer:
    - '*DoubleAgent.sln*'
    Destination:
    - '*DoubleAgent.sln*'
    Name:
    - '*DoubleAgent.sln*'
    Query:
    - '*DoubleAgent.sln*'
    NewName:
    - '*DoubleAgent.sln*'
    StartAddress:
    - '*DoubleAgent.sln*'
    StartModule:
    - '*DoubleAgent.sln*'
    StartFunction:
    - '*DoubleAgent.sln*'
    SourceHostname:
    - '*DoubleAgent.sln*'
    Device:
    - '*DoubleAgent.sln*'
    file_name:
    - '*DoubleAgent.sln*'
    file_path:
    - '*DoubleAgent.sln*'
    process:
    - '*DoubleAgent.sln*'
    original_file_name:
    - '*DoubleAgent.sln*'
    parent_process:
    - '*DoubleAgent.sln*'
    process_path:
    - '*DoubleAgent.sln*'
    service_path:
    - '*DoubleAgent.sln*'
    registry_path:
    - '*DoubleAgent.sln*'
    registry_value_data:
    - '*DoubleAgent.sln*'
    registry_value_name:
    - '*DoubleAgent.sln*'
    ContextInfo:
    - '*DoubleAgent.sln*'
    Payload:
    - '*DoubleAgent.sln*'
    ScriptBlockText:
    - '*DoubleAgent.sln*'
    ServerName:
    - '*DoubleAgent.sln*'
    TransportName:
    - '*DoubleAgent.sln*'
    NewProcessName:
    - '*DoubleAgent.sln*'
    ParentProcessName:
    - '*DoubleAgent.sln*'
    Application:
    - '*DoubleAgent.sln*'
    Product Name:
    - '*DoubleAgent.sln*'
    Threat Name:
    - '*DoubleAgent.sln*'
    Process Name:
    - '*DoubleAgent.sln*'
    Path:
    - '*DoubleAgent.sln*'
    ImagePath:
    - '*DoubleAgent.sln*'
    ServiceName:
    - '*DoubleAgent.sln*'
    ProcessPath:
    - '*DoubleAgent.sln*'
    AppName:
    - '*DoubleAgent.sln*'
    AppPath:
    - '*DoubleAgent.sln*'
    ModulePath:
    - '*DoubleAgent.sln*'
    registry.data.strings:
    - '*DoubleAgent.sln*'
    registry.path:
    - '*DoubleAgent.sln*'
    registry.value:
    - '*DoubleAgent.sln*'
    process.args:
    - '*DoubleAgent.sln*'
    process.command_line:
    - '*DoubleAgent.sln*'
    process.env_vars:
    - '*DoubleAgent.sln*'
    process.io.text:
    - '*DoubleAgent.sln*'
    process.executable:
    - '*DoubleAgent.sln*'
    process.name:
    - '*DoubleAgent.sln*'
    process.title:
    - '*DoubleAgent.sln*'
    pe.company:
    - '*DoubleAgent.sln*'
    pe.description:
    - '*DoubleAgent.sln*'
    pe.original_file_name:
    - '*DoubleAgent.sln*'
    pe.product:
    - '*DoubleAgent.sln*'
    os.full:
    - '*DoubleAgent.sln*'
    host.hostname:
    - '*DoubleAgent.sln*'
    file.fork_name:
    - '*DoubleAgent.sln*'
    file.name:
    - '*DoubleAgent.sln*'
    file.path:
    - '*DoubleAgent.sln*'
    file.target_path:
    - '*DoubleAgent.sln*'
    email.attachments.file.name:
    - '*DoubleAgent.sln*'
    email.subject:
    - '*DoubleAgent.sln*'
    dll.path:
    - '*DoubleAgent.sln*'
    device.model.name:
    - '*DoubleAgent.sln*'
    container.image.name:
    - '*DoubleAgent.sln*'
    container.name:
    - '*DoubleAgent.sln*'
    object:
    - '*DoubleAgent.sln*'
    url:
    - '*DoubleAgent.sln*'
    dest_url:
    - '*DoubleAgent.sln*'
    uri:
    - '*DoubleAgent.sln*'
    uri_query:
    - '*DoubleAgent.sln*'
    query:
    - '*DoubleAgent.sln*'
    url_domain:
    - '*DoubleAgent.sln*'
    uri_path:
    - '*DoubleAgent.sln*'
    domain:
    - '*DoubleAgent.sln*'
    QueryName:
    - '*DoubleAgent.sln*'
    QueryResults:
    - '*DoubleAgent.sln*'
    DestinationHostname:
    - '*DoubleAgent.sln*'
    DestinationIp:
    - '*DoubleAgent.sln*'
    http_referrer:
    - '*DoubleAgent.sln*'
    http_referrer_domain:
    - '*DoubleAgent.sln*'
    http_user_agent:
    - '*DoubleAgent.sln*'
    dest_nt_host:
    - '*DoubleAgent.sln*'
    sender:
    - '*DoubleAgent.sln*'
    recipient:
    - '*DoubleAgent.sln*'
    orig_recipient:
    - '*DoubleAgent.sln*'
    subject:
    - '*DoubleAgent.sln*'
    url.domain:
    - '*DoubleAgent.sln*'
    url.full:
    - '*DoubleAgent.sln*'
    url.original:
    - '*DoubleAgent.sln*'
    url.query:
    - '*DoubleAgent.sln*'
    user_agent.original:
    - '*DoubleAgent.sln*'
    network.application:
    - '*DoubleAgent.sln*'
    http.request.body.content:
    - '*DoubleAgent.sln*'
    http.request.referrer:
    - '*DoubleAgent.sln*'
    email.from.address:
    - '*DoubleAgent.sln*'
    dns.question.name:
    - '*DoubleAgent.sln*'
    destination.domain:
    - '*DoubleAgent.sln*'
  condition: selection
fields:
- Image
- OriginalFileName
- CurrentDirectory
- ParentImage
- ParentCommandLine
- TargetFilename
- Signature
- signature
- ImageLoaded
- Company
- Description
- description
- CommandLine
- SourceImage
- TargetImage
- CallTrace
- TargetObject
- Details
- PipeName
- Consumer
- Destination
- Name
- Query
- NewName
- StartAddress
- StartModule
- StartFunction
- SourceHostname
- Device
- file_name
- file_path
- process
- original_file_name
- parent_process
- process_path
- service_path
- registry_path
- registry_value_data
- registry_value_name
- ContextInfo
- Payload
- ScriptBlockText
- ServerName
- TransportName
- NewProcessName
- ParentProcessName
- Application
- Product Name
- Threat Name
- Process Name
- Path
- ImagePath
- ServiceName
- ProcessPath
- AppName
- AppPath
- ModulePath
- registry.data.strings
- registry.path
- registry.value
- process.args
- process.command_line
- process.env_vars
- process.io.text
- process.executable
- process.name
- process.title
- pe.company
- pe.description
- pe.original_file_name
- pe.product
- os.full
- host.hostname
- file.fork_name
- file.name
- file.path
- file.target_path
- email.attachments.file.name
- email.subject
- dll.path
- device.model.name
- container.image.name
- container.name
- object
- url
- dest_url
- uri
- uri_query
- query
- url_domain
- uri_path
- domain
- QueryName
- QueryResults
- DestinationHostname
- DestinationIp
- http_referrer
- http_referrer_domain
- http_user_agent
- dest_nt_host
- sender
- recipient
- orig_recipient
- subject
- url.domain
- url.full
- url.original
- url.query
- user_agent.original
- network.application
- http.request.body.content
- http.request.referrer
- email.from.address
- dns.question.name
- destination.domain
